<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yüz Algılama ve Telegram Gönderimi</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #1a1a1a; color: white; padding: 20px; }
        #info-box { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px; max-width: 600px; text-align: center; border-left: 5px solid #00bbff; }
        .container { position: relative; width: 640px; height: 480px; }
        video, canvas { position: absolute; left: 0; top: 0; border-radius: 10px; }
        #startBtn { padding: 12px 25px; font-size: 18px; cursor: pointer; background: #0088cc; color: white; border: none; border-radius: 5px; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="info-box">
        <h3>Sistem Açıklaması</h3>
        <p>Bu sistem yüzünüzü algıladığında otomatik olarak ekran görüntüsü alır ve belirlediğiniz <b>Telegram</b> adresine gönderir. Lütfen bot ayarlarınızı kodun içindeki ilgili alana giriniz.</p>
    </div>

    <div class="container">
        <video id="input_video" style="display:none;"></video>
        <canvas id="output_canvas"></canvas>
    </div>

    <button id="startBtn">Sistemi Başlat ve İzin Ver</button>

    <script>
        // --- TELEGRAM AYARLARI ---
        const TELEGRAM_BOT_TOKEN = '8567641306:AAHz1V98pDTddIXVnBlf42Sjs4bI1_cAO64';
        const TELEGRAM_CHAT_ID = '792398679';
        
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const startBtn = document.getElementById('startBtn');
        
        let lastSentTime = 0; // Sürekli fotoğraf gitmemesi için zaman kontrolü

        const faceDetection = new FaceDetection({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`
        });

        faceDetection.setOptions({ model: 'short-range', minDetectionConfidence: 0.6 });

        faceDetection.onResults(async (results) => {
            canvasCtx.save();
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            
            if (results.detections.length > 0) {
                // Yüzün etrafına çerçeve çiz
                const box = results.detections[0].boundingBox;
                canvasCtx.strokeStyle = '#00bbff';
                canvasCtx.lineWidth = 4;
                canvasCtx.strokeRect(
                    box.xCenter * canvasElement.width - (box.width * canvasElement.width / 2),
                    box.yCenter * canvasElement.height - (box.height * canvasElement.height / 2),
                    box.width * canvasElement.width,
                    box.height * canvasElement.height
                );

                // Telegram'a gönder (Her 10 saniyede en fazla 1 kare gönderir)
                const now = Date.now();
                if (now - lastSentTime > 10000) { 
                    lastSentTime = now;
                    sendToTelegram();
                }
            }
            canvasCtx.restore();
        });

        async function sendToTelegram() {
            // Canvas içeriğini resme çevir
            canvasElement.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append('chat_id', TELEGRAM_CHAT_ID);
                formData.append('photo', blob, 'face_detected.jpg');
                formData.append('caption', 'Yüz algılandı! Otomatik çekim gönderiliyor.');

                try {
                    await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendPhoto`, {
                        method: 'POST',
                        body: formData
                    });
                    console.log("Görüntü Telegram'a gönderildi.");
                } catch (e) {
                    console.error("Telegram gönderim hatası:", e);
                }
            }, 'image/jpeg');
        }

        async function startSystem() {
            await Notification.requestPermission();
            const camera = new Camera(videoElement, {
                onFrame: async () => { await faceDetection.send({image: videoElement}); },
                width: 640, height: 480
            });
            canvasElement.width = 640;
            canvasElement.height = 480;
            camera.start();
            startBtn.style.display = 'none';
        }

        startBtn.addEventListener('click', startSystem);
    </script>
</body>
</html>
</body>
</html>
